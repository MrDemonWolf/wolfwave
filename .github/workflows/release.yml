name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Skip GitHub Release creation (build only)'
        required: false
        default: 'false'

env:
  SCHEME: WolfWave
  PROJECT: src/wolfwave.xcodeproj
  CONFIGURATION: Release

jobs:
  build-and-release:
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ Create Config.xcconfig from secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Config.xcconfig
        run: |
          printf 'TWITCH_CLIENT_ID = %s\nDISCORD_CLIENT_ID = %s\n' \
            "${{ secrets.TWITCH_CLIENT_ID }}" \
            "${{ secrets.DISCORD_CLIENT_ID }}" \
            > src/wolfwave/Config.xcconfig

      # â”€â”€ Resolve version from tag or project â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resolve version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(xcodebuild -project "$PROJECT" -scheme "$SCHEME" \
              -configuration "$CONFIGURATION" -showBuildSettings 2>/dev/null \
              | awk -F'= ' '/MARKETING_VERSION/ {gsub(/^[ \t]+/,"",$2); print $2; exit}')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "dmg_name=WolfWave-${VERSION}-arm64.dmg" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Œ Version: $VERSION"

      # â”€â”€ Build Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Release
        run: |
          xcodebuild -project "$PROJECT" -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination 'platform=macOS,arch=arm64' \
            -derivedDataPath build build -quiet

      # â”€â”€ Locate .app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Locate .app bundle
        id: app
        run: |
          APP_PATH=$(xcodebuild -project "$PROJECT" -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" -derivedDataPath build \
            -showBuildSettings 2>/dev/null \
            | awk -F'= ' '/CONFIGURATION_BUILD_DIR/ {dir=$2} /WRAPPER_NAME/ {name=$2} END {gsub(/^[ \t]+/,"",dir); gsub(/^[ \t]+/,"",name); print dir "/" name}')
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ .app not found at $APP_PATH"
            exit 1
          fi
          echo "path=$APP_PATH" >> "$GITHUB_OUTPUT"
          echo "âœ… App: $APP_PATH"

      # â”€â”€ Create DMG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create DMG
        env:
          DMG_NAME: ${{ steps.version.outputs.dmg_name }}
          APP_PATH: ${{ steps.app.outputs.path }}
        run: |
          mkdir -p builds/staging
          cp -R "$APP_PATH" builds/staging/
          ln -sf /Applications builds/staging/Applications

          hdiutil create -srcfolder builds/staging \
            -volname "WolfWave" -fs HFS+ -format UDRW -ov \
            builds/_tmp.dmg >/dev/null

          MOUNTPOINT=$(hdiutil attach -readwrite -noverify -noautoopen \
            builds/_tmp.dmg | awk '/\/Volumes\// {print $NF}')
          sleep 1

          osascript \
            -e 'tell application "Finder"' \
            -e '  tell disk "WolfWave"' \
            -e '    open' \
            -e '    set current view of container window to icon view' \
            -e '    set toolbar visible of container window to false' \
            -e '    set statusbar visible of container window to false' \
            -e '    set the bounds of container window to {200, 200, 740, 520}' \
            -e '    set viewOptions to the icon view options of container window' \
            -e '    set arrangement of viewOptions to not arranged' \
            -e '    set icon size of viewOptions to 100' \
            -e '    set text size of viewOptions to 12' \
            -e '    set position of item "WolfWave.app" of container window to {140, 160}' \
            -e '    set position of item "Applications" of container window to {400, 160}' \
            -e '    close' \
            -e '    open' \
            -e '    delay 1' \
            -e '  end tell' \
            -e 'end tell' 2>/dev/null || true

          sync; sleep 1
          hdiutil detach "$MOUNTPOINT" -quiet 2>/dev/null || true
          sleep 1

          hdiutil convert builds/_tmp.dmg -format UDZO \
            -imagekey zlib-level=9 -o "builds/$DMG_NAME" >/dev/null
          rm -f builds/_tmp.dmg
          rm -rf builds/staging

          echo "âœ… DMG: builds/$DMG_NAME"

      # â”€â”€ Upload DMG as artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.dmg_name }}
          path: builds/${{ steps.version.outputs.dmg_name }}

      # â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          DMG_NAME: ${{ steps.version.outputs.dmg_name }}
        run: |
          gh release create "v$VERSION" "builds/$DMG_NAME" \
            --title "WolfWave v$VERSION" \
            --generate-notes
